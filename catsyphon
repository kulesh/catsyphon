#!/bin/sh
# CatSyphon — zero-config launcher
# Detects installed AI tools, mounts their log directories into Docker,
# and auto-bootstraps the database on first boot.
#
# Usage: ./catsyphon up | down | status | logs | reset

set -e

# ── Helpers ──────────────────────────────────────────────────────────

die()  { printf 'error: %s\n' "$1" >&2; exit 1; }
info() { printf '  %s\n' "$1"; }
bold() { printf '\033[1m%s\033[0m\n' "$1"; }

OVERRIDE_FILE="docker-compose.override.yml"
DEFAULT_PORT=3000
MIN_DOCKER_CPUS="${MIN_DOCKER_CPUS:-4}"
MIN_DOCKER_MEMORY_GB="${MIN_DOCKER_MEMORY_GB:-4}"

# ── Docker checks ────────────────────────────────────────────────────

require_docker() {
    docker info >/dev/null 2>&1 \
        || die "Docker is not running. Start your preferred runtime and try again."

    if docker compose version >/dev/null 2>&1; then
        COMPOSE="docker compose"
    elif command -v docker-compose >/dev/null 2>&1; then
        COMPOSE="docker-compose"
    else
        die "Neither 'docker compose' (v2) nor 'docker-compose' (v1) found."
    fi
}

check_docker_resources() {
    docker_cpus="$(docker info --format '{{.NCPU}}' 2>/dev/null || echo 0)"
    docker_mem_bytes="$(docker info --format '{{.MemTotal}}' 2>/dev/null || echo 0)"
    docker_mem_gb=$((docker_mem_bytes / 1024 / 1024 / 1024))

    if [ "$docker_cpus" -lt "$MIN_DOCKER_CPUS" ] || [ "$docker_mem_gb" -lt "$MIN_DOCKER_MEMORY_GB" ]; then
        die "Docker resources are too low (${docker_cpus} CPU, ${docker_mem_gb}GB RAM). Increase to at least ${MIN_DOCKER_CPUS} CPU and ${MIN_DOCKER_MEMORY_GB}GB RAM, or override with MIN_DOCKER_CPUS/MIN_DOCKER_MEMORY_GB."
    fi
}

# ── AI tool detection ────────────────────────────────────────────────

detect_tools() {
    VOLUMES=""
    WATCH_DIRS=""
    DETECTED=""

    claude_dir="$HOME/.claude"
    if [ -d "$claude_dir/projects" ]; then
        VOLUMES="${VOLUMES}        - ${claude_dir}:/data/claude:ro\n"
        WATCH_DIRS="${WATCH_DIRS}/data/claude/projects,"
        DETECTED="${DETECTED} Claude Code"
    fi

    codex_dir="$HOME/.codex"
    if [ -d "$codex_dir/sessions" ]; then
        VOLUMES="${VOLUMES}        - ${codex_dir}:/data/codex:ro\n"
        WATCH_DIRS="${WATCH_DIRS}/data/codex/sessions,"
        DETECTED="${DETECTED} Codex"
    fi

    # Strip trailing comma
    WATCH_DIRS="${WATCH_DIRS%,}"
}

# ── Override generation ──────────────────────────────────────────────

generate_override() {
    detect_tools

    ORG_NAME="$(hostname -s 2>/dev/null || echo "local")"
    WORKSPACE_NAME="Engineering"

    {
        echo "# Auto-generated by ./catsyphon — do not edit"
        echo "services:"
        echo "  backend:"

        # Volumes block (only if tools detected)
        if [ -n "$VOLUMES" ]; then
            echo "    volumes:"
            printf "%b" "$VOLUMES"
        fi

        echo "    environment:"
        echo "      AUTO_SETUP: \"true\""
        echo "      AUTO_ORG_NAME: \"${ORG_NAME}\""
        echo "      AUTO_WORKSPACE_NAME: \"${WORKSPACE_NAME}\""
        echo "      AUTO_WATCH_DIRS: \"${WATCH_DIRS}\""
    } > "$OVERRIDE_FILE"
}

# ── Port handling ────────────────────────────────────────────────────

resolve_port() {
    PORT="$DEFAULT_PORT"
    if command -v lsof >/dev/null 2>&1 && lsof -i :"$DEFAULT_PORT" -t >/dev/null 2>&1; then
        PORT=3001
        export FRONTEND_PORT="$PORT"
        info "Port $DEFAULT_PORT occupied, using $PORT"
    fi
}

# ── Wait for healthy backend ────────────────────────────────────────

wait_for_health() {
    bold "Waiting for CatSyphon to become healthy..."
    attempts=0
    max_attempts=60
    while [ "$attempts" -lt "$max_attempts" ]; do
        if curl -sf "http://localhost:${PORT}/api/health" >/dev/null 2>&1; then
            return 0
        fi
        attempts=$((attempts + 1))
        sleep 1
    done
    info "Warning: health check did not pass within ${max_attempts}s — check 'docker compose logs'"
    return 1
}

# ── Subcommands ──────────────────────────────────────────────────────

cmd_up() {
    require_docker
    check_docker_resources
    generate_override
    resolve_port

    bold "CatSyphon"
    if [ -n "$DETECTED" ]; then
        info "Detected:${DETECTED}"
    else
        info "No AI tool directories found — org and workspace will be created, add watch dirs via UI"
    fi
    info "Override:  $OVERRIDE_FILE"

    $COMPOSE up --build -d

    if wait_for_health; then
        echo ""
        bold "Ready at http://localhost:${PORT}"
    fi
}

cmd_down() {
    require_docker
    $COMPOSE down
}

cmd_status() {
    require_docker
    $COMPOSE ps
    echo ""

    detect_tools
    if [ -n "$DETECTED" ]; then
        info "Detected AI tools:${DETECTED}"
    else
        info "No AI tool directories detected"
    fi

    # Determine active port
    PORT="$DEFAULT_PORT"
    if [ -n "${FRONTEND_PORT:-}" ]; then
        PORT="$FRONTEND_PORT"
    fi
    if curl -sf "http://localhost:${PORT}/api/health" >/dev/null 2>&1; then
        info "URL: http://localhost:${PORT}"
    fi
}

cmd_logs() {
    require_docker
    $COMPOSE logs -f backend
}

cmd_reset() {
    require_docker
    bold "Resetting CatSyphon (all data will be deleted)"
    $COMPOSE down -v
    rm -f "$OVERRIDE_FILE"
    info "Done. Run './catsyphon up' to start fresh."
}

# ── Dispatch ─────────────────────────────────────────────────────────

case "${1:-}" in
    up)     cmd_up     ;;
    down)   cmd_down   ;;
    status) cmd_status ;;
    logs)   cmd_logs   ;;
    reset)  cmd_reset  ;;
    *)
        echo "Usage: ./catsyphon <up|down|status|logs|reset>"
        echo ""
        echo "  up      Detect AI tools, generate override, start stack"
        echo "  down    Stop all containers"
        echo "  status  Show container status and detected tools"
        echo "  logs    Stream backend logs"
        echo "  reset   Destroy all data and start fresh"
        echo ""
        echo "Environment variables:"
        echo "  MIN_DOCKER_CPUS        Minimum Docker CPUs required by 'up' (default: 4)"
        echo "  MIN_DOCKER_MEMORY_GB   Minimum Docker memory GB required by 'up' (default: 4)"
        exit 1
        ;;
esac
