# Claude Code Log File Format

This document describes the structure and format of log files generated by Claude Code (claude.ai/code).

## Overview

Claude Code generates conversation logs in **JSONL** (JSON Lines) format, where each line is a valid JSON object representing a message, event, or metadata snapshot in the conversation timeline.

## File Types and Naming Conventions

### Main Conversation Files

**Naming:** `{session_id}.jsonl`

**Example:** `10c62eac-5b38-4fbc-9ae4-d4182ec840b0.jsonl`

**Purpose:** Contains the primary conversation between the user and Claude Code.

**Location:** `~/.claude/projects/{project-name}/`

**Characteristics:**
- Session ID is a UUID v4
- Contains user messages, assistant responses, and tool calls
- May include metadata like file snapshots and summaries
- `isSidechain: false` (or absent) in messages

### Agent Conversation Files (Modern Format - v2.0+)

**Naming:** `agent-{agent_id}.jsonl`

**Example:** `agent-d3846599.jsonl`

**Purpose:** Contains conversations from spawned agents/subagents (e.g., Explore, Plan agents).

**Characteristics:**
- Agent ID is a short alphanumeric identifier
- `isSidechain: true` in all messages
- `agentId` field present in messages
- `sessionId` field contains the **parent conversation's** session ID (not the agent's own ID)
- Spawned from main conversation threads via Task tool

### Legacy Format Files (Pre-v2.0)

**Naming:** `{session_id}.jsonl` (same as main conversations)

**Purpose:** Mixed main and agent messages in a single file.

**Characteristics:**
- No separate agent files
- No `agentId` field in messages
- `isSidechain` flag varies per-message
- Agent and main messages interleaved

**⚠️ Parser Limitation:** Legacy format files cannot be properly separated into parent-child hierarchies. See [PARSER_LIMITATIONS.md](./PARSER_LIMITATIONS.md) for details.

## File Structure

### JSONL Format

Each file contains one JSON object per line:

```jsonl
{"field1": "value1", "field2": "value2"}
{"field1": "value3", "field2": "value4"}
{"field1": "value5", "field2": "value6"}
```

**Important:**
- Each line is independent, valid JSON
- No commas between lines
- No outer array wrapper
- Order represents chronological sequence

### Common Message Fields

All messages typically include:

| Field | Type | Description |
|-------|------|-------------|
| `uuid` | string | Unique identifier for this message |
| `parentUuid` | string\|null | UUID of the parent message (for threading) |
| `timestamp` | string | ISO 8601 timestamp (e.g., "2025-11-04T06:27:58.278Z") |
| `sessionId` | string | Session identifier (parent's ID for agents) |
| `version` | string | Claude Code version (e.g., "2.0.17") |
| `type` | string | Message type (see Message Types section) |
| `isSidechain` | boolean | True for agent messages, false/absent for main |
| `cwd` | string | Current working directory |
| `gitBranch` | string | Active git branch |
| `userType` | string | Usually "external" |

### Modern Format Agent-Specific Fields

| Field | Type | Description |
|-------|------|-------------|
| `agentId` | string | Unique agent identifier (e.g., "d3846599") |

## Message Types

### 1. User Messages

**Type:** `"type": "user"`

**Purpose:** Messages from the user to Claude.

**Structure:**
```json
{
  "parentUuid": "previous-message-uuid",
  "isSidechain": false,
  "userType": "external",
  "cwd": "/Users/username/project",
  "sessionId": "10c62eac-5b38-4fbc-9ae4-d4182ec840b0",
  "version": "2.0.17",
  "gitBranch": "main",
  "type": "user",
  "message": {
    "role": "user",
    "content": "Please help me implement feature X"
  },
  "uuid": "1e67d354-dce0-4bba-a73e-6dc2a2c5e968",
  "timestamp": "2025-10-16T19:12:28.024Z"
}
```

**Key Fields:**
- `message.role`: Always "user"
- `message.content`: The user's text input

### 2. Assistant Messages

**Type:** `"type": "assistant"`

**Purpose:** Responses from Claude Code.

**Structure:**
```json
{
  "parentUuid": "user-message-uuid",
  "isSidechain": false,
  "userType": "external",
  "cwd": "/Users/username/project",
  "sessionId": "10c62eac-5b38-4fbc-9ae4-d4182ec840b0",
  "version": "2.0.17",
  "gitBranch": "main",
  "message": {
    "model": "claude-sonnet-4-5-20250929",
    "id": "msg_01ABC...",
    "type": "message",
    "role": "assistant",
    "content": [
      {
        "type": "text",
        "text": "I'll help you implement feature X..."
      }
    ],
    "stop_reason": "end_turn",
    "stop_sequence": null,
    "usage": {
      "input_tokens": 1234,
      "cache_creation_input_tokens": 0,
      "cache_read_input_tokens": 500,
      "output_tokens": 567
    }
  },
  "requestId": "req_01XYZ...",
  "type": "assistant",
  "uuid": "cc1baec6-dfb4-4e43-b852-84668523c6b3",
  "timestamp": "2025-10-16T19:12:30.199Z"
}
```

**Key Fields:**
- `message.model`: Claude model used
- `message.content`: Array of content blocks (text, tool_use, etc.)
- `message.usage`: Token usage statistics
- `requestId`: API request identifier

**Content Block Types:**

**Text block:**
```json
{
  "type": "text",
  "text": "Response text here"
}
```

**Tool use block:**
```json
{
  "type": "tool_use",
  "id": "toolu_01ABC...",
  "name": "Read",
  "input": {
    "file_path": "/path/to/file.py"
  }
}
```

**Thinking block:**
```json
{
  "type": "thinking",
  "thinking": "Internal reasoning here..."
}
```

### 3. Tool Result Messages

**Type:** `"type": "tool-result"`

**Purpose:** Results from tool executions (Read, Write, Bash, etc.).

**Structure:**
```json
{
  "parentUuid": "assistant-message-uuid",
  "isSidechain": false,
  "userType": "external",
  "cwd": "/Users/username/project",
  "sessionId": "10c62eac-5b38-4fbc-9ae4-d4182ec840b0",
  "version": "2.0.17",
  "gitBranch": "main",
  "type": "tool-result",
  "message": {
    "role": "user",
    "content": [
      {
        "type": "tool_result",
        "tool_use_id": "toolu_01ABC...",
        "content": "File contents here...",
        "is_error": false
      }
    ]
  },
  "uuid": "9dfc0818-775e-47a7-8d89-b942624a21fa",
  "timestamp": "2025-10-16T19:12:31.123Z"
}
```

**Key Fields:**
- `message.content[].tool_use_id`: Links to the tool_use block
- `message.content[].content`: Tool execution result
- `message.content[].is_error`: Boolean indicating success/failure

### 4. Summary Messages

**Type:** `"type": "summary"`

**Purpose:** AI-generated conversation summaries.

**Structure:**
```json
{
  "type": "summary",
  "summary": "Release Instructions Documentation for tc",
  "leafUuid": "9ea8b555-017b-4c8d-b39a-79be6cbc207a"
}
```

**Key Fields:**
- `summary`: Brief description of conversation topic
- `leafUuid`: Reference to related message

### 5. File History Snapshot Messages

**Type:** `"type": "file-history-snapshot"`

**Purpose:** Captures tracked file states at specific points.

**Structure:**
```json
{
  "type": "file-history-snapshot",
  "messageId": "1c5c7dbb-e559-4ae8-9d9f-e9766a7f685b",
  "snapshot": {
    "messageId": "1c5c7dbb-e559-4ae8-9d9f-e9766a7f685b",
    "trackedFileBackups": {
      "README.md": {
        "backupFileName": "8de030122ded0b58@v5",
        "version": 5,
        "backupTime": "2025-11-04T15:45:55.858Z"
      },
      "src/main.rs": {
        "backupFileName": "711f76b698555586@v3",
        "version": 3,
        "backupTime": "2025-11-04T06:20:32.076Z"
      }
    },
    "timestamp": "2025-11-04T15:45:55.850Z"
  },
  "isSnapshotUpdate": false
}
```

**Key Fields:**
- `snapshot.trackedFileBackups`: Object mapping file paths to backup metadata
- `backupFileName`: Identifier for the backed-up version
- `version`: File version number
- `backupTime`: When the backup was created

### 6. Command Messages (Slash Commands)

**Type:** `"type": "user"` with `isMeta: true`

**Purpose:** Execution of slash commands like `/login`, `/help`, etc.

**Structure:**
```json
{
  "parentUuid": null,
  "isSidechain": false,
  "userType": "external",
  "cwd": "/Users/username/project",
  "sessionId": "904bb889-576c-4193-9fb9-2780c4db9028",
  "version": "2.0.17",
  "gitBranch": "main",
  "type": "user",
  "message": {
    "role": "user",
    "content": "<command-name>/login</command-name>\n<command-message>login</command-message>\n<command-args></command-args>"
  },
  "isMeta": true,
  "uuid": "3bd09ceb-e7e3-42d2-8396-99db73c84539",
  "timestamp": "2025-10-16T19:13:17.834Z"
}
```

**Key Fields:**
- `isMeta: true`: Indicates system/meta message
- `message.content`: XML-formatted command structure

## Agent Conversation Specifics

### Modern Format (v2.0+)

**File:** `agent-{agent_id}.jsonl`

**Key Characteristics:**
- Every message has `"isSidechain": true`
- `agentId` field present (e.g., "d3846599")
- `sessionId` contains **parent's** session ID, not agent's own
- Agent's unique identifier is the `agentId` field

**Example:**
```json
{
  "parentUuid": null,
  "isSidechain": true,
  "agentId": "d3846599",
  "userType": "external",
  "cwd": "/Users/username/project",
  "sessionId": "10c62eac-5b38-4fbc-9ae4-d4182ec840b0",
  "version": "2.0.17",
  "gitBranch": "main",
  "type": "user",
  "message": {
    "role": "user",
    "content": "Search for error handling code"
  },
  "uuid": "agent-msg-uuid",
  "timestamp": "2025-11-04T06:27:58.278Z"
}
```

**Parent-Child Relationship:**
- Agent file: `agent-d3846599.jsonl`
- Agent's `agentId`: "d3846599" (unique agent identifier)
- Agent's `sessionId`: "10c62eac-5b38-4fbc-9ae4-d4182ec840b0" (parent's session)
- Parent file: `10c62eac-5b38-4fbc-9ae4-d4182ec840b0.jsonl`

### Legacy Format (Pre-v2.0)

**File:** `{session_id}.jsonl` (mixed messages)

**Key Characteristics:**
- No `agentId` field
- `isSidechain` varies per-message (true for agent, false for main)
- Agent and main messages in same file
- Cannot be reliably separated into hierarchical structure

**Example:**
```json
{
  "parentUuid": null,
  "isSidechain": true,
  "sessionId": "904bb889-576c-4193-9fb9-2780c4db9028",
  "version": "2.0.17",
  "type": "user",
  "message": {
    "role": "user",
    "content": "Agent task"
  },
  "uuid": "msg-uuid",
  "timestamp": "2025-10-16T19:12:28.024Z"
}
```

**⚠️ Limitation:** Parser cannot extract parent-child relationships from legacy format. See [PARSER_LIMITATIONS.md](./PARSER_LIMITATIONS.md).

## File Locations

### Default Directory Structure

```
~/.claude/
└── projects/
    ├── -Users-username-project1/
    │   ├── 10c62eac-5b38-4fbc-9ae4-d4182ec840b0.jsonl  # Main conversation
    │   ├── agent-d3846599.jsonl                         # Agent 1
    │   ├── agent-b164fcb0.jsonl                         # Agent 2
    │   └── ...
    └── -Users-username-project2/
        ├── c8961b40-7d41-4366-91e6-5c5d185f58c2.jsonl  # Main conversation
        └── ...
```

**Project Directory Naming:**
- Format: `-{absolute-path-with-dashes}`
- Example: `/Users/kulesh/dev/myproject` → `-Users-kulesh-dev-myproject`

## Version History

### v2.0+ (Modern Format)
- Separate agent files: `agent-{id}.jsonl`
- `agentId` field in messages
- Clear parent-child hierarchy
- Better organization

### Pre-v2.0 (Legacy Format)
- Mixed agent/main in single file
- No `agentId` field
- Per-message `isSidechain` flag
- No file-level separation

## Incomplete/Empty Files

Occasionally, Claude Code may create files that contain only metadata without actual conversation messages:

**Characteristics:**
- 2-12 lines only
- Only `summary` and/or `file-history-snapshot` messages
- No `sessionId` or `version` fields in any message
- No user/assistant conversation

**Example:**
```jsonl
{"type":"summary","summary":"Project setup","leafUuid":"..."}
{"type":"file-history-snapshot","messageId":"...","snapshot":{...}}
```

**Parser Behavior:**
- These files are **correctly rejected** by `can_parse()`
- Not ingested into the database
- Child agents referencing these as parents remain orphaned

**Cause:** Likely conversations that were started but immediately closed before any messages were exchanged.

## Parsing Considerations

### Format Detection

The parser determines if a file is valid Claude Code format by:

1. Checking file extension is `.jsonl`
2. Scanning **entire file** for at least one message with both:
   - `sessionId` field
   - `version` field

### Message Threading

Messages are linked via `parentUuid`:
- First message in conversation: `parentUuid: null`
- Subsequent messages: `parentUuid` points to previous message's `uuid`
- Creates a chronological chain of messages

### Tool Call Matching

Tool calls and results are matched by:
- Assistant message contains `tool_use` block with `id`
- Tool result message contains `tool_result` block with matching `tool_use_id`

Example:
```json
// Assistant message with tool_use
{
  "type": "assistant",
  "message": {
    "content": [
      {
        "type": "tool_use",
        "id": "toolu_01ABC123",
        "name": "Read",
        "input": {"file_path": "/path/to/file"}
      }
    ]
  }
}

// Tool result message
{
  "type": "tool-result",
  "message": {
    "content": [
      {
        "type": "tool_result",
        "tool_use_id": "toolu_01ABC123",
        "content": "File contents..."
      }
    ]
  }
}
```

## Examples

See the parser implementation at `backend/src/catsyphon/parsers/claude_code.py` for complete parsing logic.

For limitations and edge cases, see [PARSER_LIMITATIONS.md](./PARSER_LIMITATIONS.md).

## References

- Claude Code: https://code.claude.com
- Parser implementation: `backend/src/catsyphon/parsers/claude_code.py`
- Parser limitations: `docs/PARSER_LIMITATIONS.md`
